<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ä¿é¤Šå“æƒç¢¼æ–°å¢</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Arial;
      padding: 12px;
      background: #fafafa;
    }
    .card {
      max-width: 520px;
      margin: 0 auto;
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    video {
      width: 100%;
      border-radius: 14px;
      background: #000;
    }
    .row {
      margin: 10px 0;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #ddd;
      box-sizing: border-box;
      font-size: 15px;
    }
    button {
      border: 0;
      background: #1565c0;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      background: #0d47a1;
    }
    .hint {
      color: #666;
      font-size: 13px;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h3>ä¿é¤Šå“æƒç¢¼æ–°å¢</h3>
    <video id="preview" autoplay playsinline></video>

    <div class="row">
      <label>æ¢ç¢¼
        <input id="barcode" placeholder="è‡ªå‹•å¸¶å…¥ï¼Œæˆ–æ‰‹å‹•è¼¸å…¥" />
      </label>
    </div>

    <div class="row">
      <button id="btnNoBarcode" type="button">æ²’æœ‰æ¢ç¢¼ï¼ˆå»ºç«‹å…§éƒ¨IDï¼‰</button>
    </div>

    <div class="row">
      <label>å“å
        <input id="name" placeholder="å¯ç•™ç™½ï¼Œæœƒè‡ªå‹•å¸¶æˆ–ä¹‹å¾Œè£œ" />
      </label>
    </div>

    <div class="row">
      <label>æ•ˆæœŸ
        <input id="expiry" type="date" />
      </label>
    </div>

    <div class="row">
      <label>é–‹å°æ—¥
        <input id="opened" type="date" />
      </label>
    </div>

    <div class="row">
      <label>åˆ†é¡
        <select id="cat">
          <option>ç²¾è¯</option>
          <option>åŒ–å¦æ°´</option>
          <option>ä¹³æ¶²</option>
          <option>é¢è†œ</option>
          <option>é˜²æ›¬</option>
          <option>å…¶ä»–</option>
        </select>
      </label>
    </div>

    <div class="row">
      <label>å‚™è¨»
        <textarea id="note" rows="2" placeholder="å¯ç”¨èªéŸ³è¼¸å…¥"></textarea>
      </label>
    </div>

    <div class="row">
      <button id="submit">å¿«é€Ÿé€å‡º</button>
    </div>

    <div class="hint" id="status"></div>
  </div>

  <script type="module">
    import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/library@latest/+esm";
    const codeReader = new BrowserMultiFormatReader();
    const video = document.getElementById("preview");
    const barcode = document.getElementById("barcode");
    const opened = document.getElementById("opened");
    const status = document.getElementById("status");
    opened.value = new Date().toISOString().slice(0, 10);

    // âš ï¸ ä¿®æ”¹æˆä½ çš„ Google Apps Script éƒ¨ç½²ç¶²å€
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbxtzZ7n6O7a_uGonhJEG6OwcPdLHWhK97zyJWTjXdDYKh5UqFl9-IvzmvWyHv0FIZQY/exec";

    // é–‹å•Ÿé¡é ­
    try {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const backCam = devices.find(
        (d) => d.kind === "videoinput" && /back|rear|ç’°å¢ƒ/i.test(d.label)
      );
      const constraints = {
        video: backCam
          ? { deviceId: backCam.deviceId }
          : { facingMode: "environment" },
      };
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;

      codeReader.decodeFromVideoDevice(null, "preview", (result, err) => {
        if (result) {
          barcode.value = result.getText();
          if (navigator.vibrate) navigator.vibrate(60);
          status.textContent = "âœ… å·²æƒåˆ°æ¢ç¢¼ï¼š" + barcode.value;
        }
      });
    } catch (e) {
      status.textContent = "âš ï¸ ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿï¼š" + e;
    }

    // æ²’æœ‰æ¢ç¢¼çš„æ¨¡å¼
    document.getElementById("btnNoBarcode").onclick = () => {
      barcode.value = "";
      status.textContent = "ğŸ‘‰ å°‡ä»¥å…§éƒ¨IDå»ºç«‹ï¼ˆç„¡æ¢ç¢¼ï¼‰";
    };

    // æäº¤è³‡æ–™
    document.getElementById("submit").onclick = async () => {
      const payload = {
        id: undefined, // è®“å¾Œç«¯è‡ªå‹•ç”¢ç”Ÿ
        barcode: barcode.value.trim(),
        name: document.getElementById("name").value.trim(),
        expiry: document.getElementById("expiry").value,
        opened: document.getElementById("opened").value,
        category: document.getElementById("cat").value,
        note: document.getElementById("note").value.trim(),
        ts: new Date().toISOString(),
      };

      if (!payload.barcode && !payload.name) {
        alert("æ²’æœ‰æ¢ç¢¼æ™‚è«‹è‡³å°‘å¡«ã€å“åã€");
        return;
      }

      try {
        const res = await fetch(GAS_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const json = await res.json();
        if (json.ok) {
          alert("âœ… æ–°å¢æˆåŠŸï¼š" + (json.data.name || "(æœªå‘½å)"));
          document.getElementById("name").value = "";
          document.getElementById("expiry").value = "";
          document.getElementById("note").value = "";
        } else {
          alert("é€å‡ºå¤±æ•—ï¼š" + (json.error || "æœªçŸ¥éŒ¯èª¤"));
        }
      } catch (e) {
        alert("é€£ç·šå¤±æ•—ï¼š" + e);
      }
    };
  </script>
</body>
</html>
