<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>保養品掃碼新增</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Arial;
      padding: 12px;
      background: #fafafa;
    }
    .card {
      max-width: 520px;
      margin: 0 auto;
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    video {
      width: 100%;
      border-radius: 14px;
      background: #000;
    }
    .row {
      margin: 10px 0;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #ddd;
      box-sizing: border-box;
      font-size: 15px;
    }
    button {
      border: 0;
      background: #1565c0;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      background: #0d47a1;
    }
    .hint {
      color: #666;
      font-size: 13px;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h3>保養品掃碼新增</h3>
    <video id="preview" autoplay playsinline></video>

    <div class="row">
      <label>條碼
        <input id="barcode" placeholder="自動帶入，或手動輸入" />
      </label>
    </div>

    <div class="row">
      <button id="btnNoBarcode" type="button">沒有條碼（建立內部ID）</button>
    </div>

    <div class="row">
      <label>品名
        <input id="name" placeholder="可留白，會自動帶或之後補" />
      </label>
    </div>

    <div class="row">
      <label>效期
        <input id="expiry" type="date" />
      </label>
    </div>

    <div class="row">
      <label>開封日
        <input id="opened" type="date" />
      </label>
    </div>

    <div class="row">
      <label>分類
        <select id="cat">
          <option>精華</option>
          <option>化妝水</option>
          <option>乳液</option>
          <option>面膜</option>
          <option>防曬</option>
          <option>其他</option>
        </select>
      </label>
    </div>

    <div class="row">
      <label>備註
        <textarea id="note" rows="2" placeholder="可用語音輸入"></textarea>
      </label>
    </div>

    <div class="row">
      <button id="submit">快速送出</button>
    </div>

    <div class="hint" id="status"></div>
  </div>

  <script type="module">
    import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/library@latest/+esm";
    const codeReader = new BrowserMultiFormatReader();
    const video = document.getElementById("preview");
    const barcode = document.getElementById("barcode");
    const opened = document.getElementById("opened");
    const status = document.getElementById("status");
    opened.value = new Date().toISOString().slice(0, 10);

    // ⚠️ 修改成你的 Google Apps Script 部署網址
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbxtzZ7n6O7a_uGonhJEG6OwcPdLHWhK97zyJWTjXdDYKh5UqFl9-IvzmvWyHv0FIZQY/exec";

    // 開啟鏡頭
    try {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const backCam = devices.find(
        (d) => d.kind === "videoinput" && /back|rear|環境/i.test(d.label)
      );
      const constraints = {
        video: backCam
          ? { deviceId: backCam.deviceId }
          : { facingMode: "environment" },
      };
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;

      codeReader.decodeFromVideoDevice(null, "preview", (result, err) => {
        if (result) {
          barcode.value = result.getText();
          if (navigator.vibrate) navigator.vibrate(60);
          status.textContent = "✅ 已掃到條碼：" + barcode.value;
        }
      });
    } catch (e) {
      status.textContent = "⚠️ 無法開啟相機：" + e;
    }

    // 沒有條碼的模式
    document.getElementById("btnNoBarcode").onclick = () => {
      barcode.value = "";
      status.textContent = "👉 將以內部ID建立（無條碼）";
    };

    // 提交資料
    document.getElementById("submit").onclick = async () => {
      const payload = {
        id: undefined, // 讓後端自動產生
        barcode: barcode.value.trim(),
        name: document.getElementById("name").value.trim(),
        expiry: document.getElementById("expiry").value,
        opened: document.getElementById("opened").value,
        category: document.getElementById("cat").value,
        note: document.getElementById("note").value.trim(),
        ts: new Date().toISOString(),
      };

      if (!payload.barcode && !payload.name) {
        alert("沒有條碼時請至少填『品名』");
        return;
      }

      try {
        const res = await fetch(GAS_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const json = await res.json();
        if (json.ok) {
          alert("✅ 新增成功：" + (json.data.name || "(未命名)"));
          document.getElementById("name").value = "";
          document.getElementById("expiry").value = "";
          document.getElementById("note").value = "";
        } else {
          alert("送出失敗：" + (json.error || "未知錯誤"));
        }
      } catch (e) {
        alert("連線失敗：" + e);
      }
    };
  </script>
</body>
</html>
