<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>保養品掃碼新增</title>
  <style>
    body{font-family:system-ui,-apple-system,Arial;background:#fafafa;padding:12px}
    .card{max-width:520px;margin:0 auto;background:#fff;border-radius:14px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    video{width:100%;border-radius:14px;background:#000}
    .row{margin:10px 0}
    input,select,textarea,button{width:100%;padding:12px;border-radius:12px;border:1px solid #ddd;box-sizing:border-box}
    button{border:0;background:#1565c0;color:#fff;font-weight:600;cursor:pointer}
    button.secondary{background:#666}
    .hint{color:#666;font-size:13px;margin-top:6px}
    .imgbox{margin:8px 0;display:none}
    .imgbox img{width:100%;max-height:180px;object-fit:cover;border-radius:10px;background:#eee}
    .actions{display:flex;gap:10px}
  </style>
</head>
<body>
  <div class="card">
    <h3>保養品掃碼新增</h3>

    <video id="preview" autoplay playsinline></video>
    <div class="actions" style="margin-top:8px">
      <button id="btnStart">啟用掃描</button>
      <button id="btnStop" class="secondary">停止掃描</button>
    </div>

    <div class="imgbox" id="imgBox">
      <img id="prodImg" alt="商品圖片"/>
    </div>

    <div class="row"><label>條碼
      <input id="barcode" placeholder="自動帶入，或手動輸入" />
    </label></div>

    <div class="actions">
      <button id="btnNoBarcode" type="button" class="secondary">沒有條碼（建立內部ID）</button>
      <button id="btnLookup" type="button" class="secondary">查資料</button>
    </div>

    <div class="row"><label>品名
      <input id="name" placeholder="若查到會自動帶；也可手動/語音輸入" />
    </label></div>

    <div class="row"><label>品牌
      <input id="brand" placeholder="若查到會自動帶" />
    </label></div>

    <div class="row"><label>效期
      <input id="expiry" type="date" />
    </label></div>

    <div class="row"><label>開封日
      <input id="opened" type="date" /> <!-- 預設留空 -->
    </label></div>

    <div class="row"><label>分類
      <select id="cat">
        <option>精華</option><option>化妝水</option><option>乳液</option><option>面膜</option><option>防曬</option><option>其他</option>
      </select>
    </label></div>

    <div class="row"><label>備註
      <textarea id="note" rows="2" placeholder="可用語音輸入"></textarea>
    </label></div>

    <div class="actions">
      <button id="submit">快速送出</button>
    </div>

    <div class="hint" id="status"></div>
  </div>

  <script type="module">
    import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/library@latest/+esm";
    const codeReader = new BrowserMultiFormatReader();

    const video   = document.getElementById("preview");
    const barcode = document.getElementById("barcode");
    const nameEl  = document.getElementById("name");
    const brandEl = document.getElementById("brand");
    const status  = document.getElementById("status");
    const imgBox  = document.getElementById("imgBox");
    const prodImg = document.getElementById("prodImg");

    // 換成你的 Apps Script /exec URL
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbxtzZ7n6O7a_uGonhJEG6OwcPdLHWhK97zyJWTjXdDYKh5UqFl9-IvzmvWyHv0FIZQY/exec";

    let stream = null;
    let scanning = false;
    let handledThisScan = false;

    async function startScan(){
      if (scanning) return;
      handledThisScan = false;
      try{
        const devices = await navigator.mediaDevices.enumerateDevices();
        const backCam = devices.find(d => d.kind === "videoinput" && /back|rear|環境/i.test(d.label));
        const constraints = { video: backCam ? { deviceId: backCam.deviceId } : { facingMode: "environment" } };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        scanning = true;
        status.textContent = "相機已啟用，請對準條碼…";

        codeReader.decodeFromVideoDevice(null, "preview", (result, err) => {
          if (result && !handledThisScan){
            handledThisScan = true;
            barcode.value = result.getText();
            if (navigator.vibrate) navigator.vibrate(60);
            status.textContent = "✅ 已掃到條碼：" + barcode.value + "（已自動停止掃描並查資料）";
            stopScan();               // 掃到即停
            lookup();                 // 立刻查資料（不會覆蓋你已輸入的文字）
          }
        });
      }catch(e){
        status.textContent = "⚠️ 無法開啟相機：" + e;
      }
    }
    function stopScan(){
      try{ codeReader.reset(); }catch{}
      try{
        if (stream){
          stream.getTracks().forEach(t => t.stop());
          stream = null;
        }
      }catch{}
      scanning = false;
    }

    document.getElementById("btnStart").onclick = startScan;
    document.getElementById("btnStop").onclick  = stopScan;

    document.getElementById("btnNoBarcode").onclick = ()=>{
      barcode.value = "";
      status.textContent = "👉 將以內部ID建立（無條碼）";
      stopScan();
    };

    document.getElementById("btnLookup").onclick = lookup;

    // 只在欄位「目前為空」時才寫入，避免洗掉你手動輸入
    function setIfEmpty(inputEl, val){
      if (!inputEl.value && val) inputEl.value = val;
    }

    // 先試 GAS lookup；失敗就打 OBF 端點
    async function lookup(){
      const bc = barcode.value.trim();
      if (!bc){ alert("請先輸入或掃描條碼"); return; }

      try{
        // 1) 嘗試 GAS lookup（如果你尚未在 app.gs 寫這個分支，會回錯誤 → 進入 catch）
        const url = `${GAS_ENDPOINT}?mode=lookup&barcode=${encodeURIComponent(bc)}`;
        const res = await fetch(url);
        if (res.ok){
          const json = await res.json();
          if (json && json.ok && json.data){
            applyLookup(json.data, /*from*/ 'GAS');
            return;
          }
        }
        throw new Error('GAS lookup not available');
      }catch{
        // 2) 直接查 OBF（v2→v0）
        try{
          const fields = 'product_name,product_name_zh,product_name_zh-TW,brands,ingredients_text,ingredients_text_zh,ingredients_text_zh-TW,image_url,code';
          const v2 = await fetch(`https://world.openbeautyfacts.org/api/v2/product/${encodeURIComponent(bc)}?fields=${encodeURIComponent(fields)}`);
          let data = v2.ok ? await v2.json() : null;
          if (!(data && (data.product))) {
            const v0 = await fetch(`https://world.openbeautyfacts.org/api/v0/product/${encodeURIComponent(bc)}.json?fields=${encodeURIComponent(fields)}`);
            data = v0.ok ? await v0.json() : null;
          }
          if (data && data.product){
            const p = data.product;
            const payload = {
              name: p['product_name_zh-TW'] || p['product_name_zh'] || p['product_name'] || '',
              brand: p['brands'] || '',
              image_url: p['image_url'] || '',
              source: 'obf'
            };
            applyLookup(payload, /*from*/ 'OBF');
          }else{
            status.textContent = "查無資料，可手動輸入。";
            imgBox.style.display = "none";
          }
        }catch(e2){
          status.textContent = "查詢失敗：" + e2;
        }
      }
    }

    function applyLookup(d, from){
      setIfEmpty(nameEl,  d.name);
      setIfEmpty(brandEl, d.brand);
      if (d.image_url){
        prodImg.src = d.image_url;
        imgBox.style.display = "block";
      }else{
        imgBox.style.display = "none";
      }
      status.textContent = `📦 已帶入（${from}）：${d.name || ''}`;
    }

    // 送出（存檔）— 使用 POST，且不設定 Content-Type（避免 CORS 預檢）
    document.getElementById("submit").onclick = async ()=>{
      const payload = {
        id: undefined,
        barcode: barcode.value.trim(),
        name: nameEl.value.trim(),
        brand: brandEl.value.trim(),
        expiry: document.getElementById("expiry").value,
        opened: document.getElementById("opened").value,   // 允許空白
        category: document.getElementById("cat").value,
        note: document.getElementById("note").value.trim(),
        ts: new Date().toISOString(),
      };
      if (!payload.barcode && !payload.name){
        alert("沒有條碼時請至少填『品名』");
        return;
      }
      try{
        const res = await fetch(GAS_ENDPOINT, { method:"POST", body: JSON.stringify(payload) });
        const json = await res.json();
        if (json.ok){
          alert("✅ 新增成功：" + (json.data.name || "(未命名)"));
          // 清空只清「可能想重填」的欄位；不觸及你剛手動鍵入的其他欄位
          nameEl.value = "";
          brandEl.value = "";
          document.getElementById("expiry").value = "";
          document.getElementById("note").value = "";
          imgBox.style.display = "none";
        }else{
          alert("送出失敗：" + (json.error || "未知錯誤"));
        }
      }catch(e){
        alert("連線失敗：" + e);
      }
    };
  </script>
</body>
</html>
