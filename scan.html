<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>保養品掃碼新增</title>
  <style>
    body{font-family:system-ui,-apple-system,Arial;background:#fafafa;padding:12px}
    .card{max-width:520px;margin:0 auto;background:#fff;border-radius:14px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    video{width:100%;border-radius:14px;background:#000}
    .row{margin:10px 0}
    input,select,textarea,button{width:100%;padding:12px;border-radius:12px;border:1px solid #ddd;box-sizing:border-box}
    button{border:0;background:#1565c0;color:#fff;font-weight:600;cursor:pointer}
    button.secondary{background:#666}
    .hint{color:#666;font-size:13px;margin-top:6px}
    .imgbox{margin:8px 0}
    .imgbox img{width:100%;max-height:180px;object-fit:cover;border-radius:10px;background:#eee}
    .actions{display:flex;gap:10px}
  </style>
</head>
<body>
  <div class="card">
    <h3>保養品掃碼新增</h3>

    <video id="preview" autoplay playsinline></video>
    <div class="actions" style="margin-top:8px">
      <button id="btnStart">啟用掃描</button>
      <button id="btnStop" class="secondary">停止掃描</button>
    </div>

    <div class="imgbox" id="imgBox" style="display:none">
      <img id="prodImg" alt="商品圖片"/>
    </div>

    <div class="row"><label>條碼
      <input id="barcode" placeholder="自動帶入，或手動輸入" />
    </label></div>

    <div class="actions">
      <button id="btnNoBarcode" type="button" class="secondary">沒有條碼（建立內部ID）</button>
      <button id="btnLookup" type="button" class="secondary">查資料</button>
    </div>

    <div class="row"><label>品名
      <input id="name" placeholder="掃到會自動帶；也可手動/語音輸入" />
    </label></div>

    <div class="row"><label>品牌
      <input id="brand" placeholder="若能查到會自動帶" />
    </label></div>

    <div class="row"><label>效期
      <input id="expiry" type="date" />
    </label></div>

    <div class="row"><label>開封日
      <input id="opened" type="date" />
    </label></div>

    <div class="row"><label>分類
      <select id="cat">
        <option>精華</option><option>化妝水</option><option>乳液</option><option>面膜</option><option>防曬</option><option>其他</option>
      </select>
    </label></div>

    <div class="row"><label>備註
      <textarea id="note" rows="2" placeholder="可用語音輸入"></textarea>
    </label></div>

    <div class="actions">
      <button id="submit">快速送出</button>
    </div>

    <div class="hint" id="status"></div>
  </div>

  <script type="module">
    import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/library@latest/+esm";
    const codeReader = new BrowserMultiFormatReader();

    const video   = document.getElementById("preview");
    const barcode = document.getElementById("barcode");
    const opened  = document.getElementById("opened");
    const status  = document.getElementById("status");
    const imgBox  = document.getElementById("imgBox");
    const prodImg = document.getElementById("prodImg");
    opened.value = new Date().toISOString().slice(0,10);

    // 換成你的 Apps Script Web App URL（/exec）
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbxtzZ7n6O7a_uGonhJEG6OwcPdLHWhK97zyJWTjXdDYKh5UqFl9-IvzmvWyHv0FIZQY/exec";

    let stream = null;
    let scanning = false;

    async function startScan(){
      if (scanning) return;
      try{
        const devices = await navigator.mediaDevices.enumerateDevices();
        const backCam = devices.find(d => d.kind === "videoinput" && /back|rear|環境/i.test(d.label));
        const constraints = { video: backCam ? { deviceId: backCam.deviceId } : { facingMode: "environment" } };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        scanning = true;
        status.textContent = "相機已啟用，請對準條碼…";

        codeReader.decodeFromVideoDevice(null, "preview", (result, err) => {
          if (result){
            barcode.value = result.getText();
            if (navigator.vibrate) navigator.vibrate(60);
            status.textContent = "✅ 已掃到條碼：" + barcode.value + "（已自動停止掃描）";
            stopScan();               // 掃到即停
            lookup();                 // 立刻查資料並帶入
          }
        });
      }catch(e){
        status.textContent = "⚠️ 無法開啟相機：" + e;
      }
    }
    function stopScan(){
      try{ codeReader.reset(); }catch{}
      try{
        if (stream){
          stream.getTracks().forEach(t => t.stop());
          stream = null;
        }
      }catch{}
      scanning = false;
    }

    document.getElementById("btnStart").onclick = startScan;
    document.getElementById("btnStop").onclick  = stopScan;

    document.getElementById("btnNoBarcode").onclick = ()=>{
      barcode.value = "";
      status.textContent = "👉 將以內部ID建立（無條碼）";
      stopScan();
    };

    document.getElementById("btnLookup").onclick = lookup;

    // 即時查詢（不存檔）：向 GAS 要 OBF/Mapping 帶入資料
    async function lookup(){
      const bc = barcode.value.trim();
      if (!bc){ alert("請先輸入或掃描條碼"); return; }
      try{
        const url = `${GAS_ENDPOINT}?mode=lookup&barcode=${encodeURIComponent(bc)}`;
        const res = await fetch(url);                 // GET，避免 CORS 預檢
        const json = await res.json();
        if (json.ok && json.data){
          const d = json.data;
          document.getElementById("name").value  = d.name  || "";
          document.getElementById("brand").value = d.brand || "";
          if (d.image_url){
            prodImg.src = d.image_url;
            imgBox.style.display = "block";
          }else{
            imgBox.style.display = "none";
          }
          status.textContent = `📦 已帶入：${d.source || "-"} ${d.name || ""}`;
        }else{
          status.textContent = "查無資料，可手動輸入。";
          imgBox.style.display = "none";
        }
      }catch(e){
        status.textContent = "查詢失敗：" + e;
      }
    }

    // 送出（存檔）
    document.getElementById("submit").onclick = async ()=>{
      const payload = {
        id: undefined, // 讓後端自動產生
        barcode: barcode.value.trim(),
        name: document.getElementById("name").value.trim(),
        brand: document.getElementById("brand").value.trim(),
        expiry: document.getElementById("expiry").value,
        opened: document.getElementById("opened").value,
        category: document.getElementById("cat").value,
        note: document.getElementById("note").value.trim(),
        ts: new Date().toISOString(),
      };
      if (!payload.barcode && !payload.name){
        alert("沒有條碼時請至少填『品名』");
        return;
      }
      try{
        const res = await fetch(GAS_ENDPOINT, {
          method: "POST",
          // 不設 Content-Type，避免觸發 CORS 預檢
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        if (json.ok){
          alert("✅ 新增成功：" + (json.data.name || "(未命名)"));
          document.getElementById("name").value="";
          document.getElementById("brand").value="";
          document.getElementById("expiry").value="";
          document.getElementById("note").value="";
        }else{
          alert("送出失敗：" + (json.error || "未知錯誤"));
        }
      }catch(e){
        alert("連線失敗：" + e);
      }
    };

    // 預設就啟用一次掃描，掃到會自動停
    startScan();
  </script>
</body>
</html>
