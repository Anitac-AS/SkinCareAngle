<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ä¿é¤Šå“æƒç¢¼æ–°å¢</title>
  <style>
    body{font-family:system-ui,-apple-system,Arial;background:#fafafa;padding:12px}
    .card{max-width:520px;margin:0 auto;background:#fff;border-radius:14px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    video{width:100%;border-radius:14px;background:#000}
    .row{margin:10px 0}
    input,select,textarea,button{width:100%;padding:12px;border-radius:12px;border:1px solid #ddd;box-sizing:border-box}
    button{border:0;background:#1565c0;color:#fff;font-weight:600;cursor:pointer}
    button.secondary{background:#666}
    .hint{color:#666;font-size:13px;margin-top:6px}
    .imgbox{margin:8px 0;display:none}
    .imgbox img{width:100%;max-height:180px;object-fit:cover;border-radius:10px;background:#eee}
    .actions{display:flex;gap:10px}
  </style>
</head>
<body>
  <div class="card">
    <h3>ä¿é¤Šå“æƒç¢¼æ–°å¢</h3>

    <video id="preview" autoplay playsinline></video>
    <div class="actions" style="margin-top:8px">
      <button id="btnStart">å•Ÿç”¨æƒæ</button>
      <button id="btnStop" class="secondary">åœæ­¢æƒæ</button>
    </div>

    <div class="imgbox" id="imgBox">
      <img id="prodImg" alt="å•†å“åœ–ç‰‡"/>
    </div>

    <div class="row"><label>æ¢ç¢¼
      <input id="barcode" placeholder="è‡ªå‹•å¸¶å…¥ï¼Œæˆ–æ‰‹å‹•è¼¸å…¥" />
    </label></div>

    <div class="actions">
      <button id="btnNoBarcode" type="button" class="secondary">æ²’æœ‰æ¢ç¢¼ï¼ˆå»ºç«‹å…§éƒ¨IDï¼‰</button>
      <button id="btnLookup" type="button" class="secondary">æŸ¥è³‡æ–™</button>
    </div>

    <div class="row"><label>å“å
      <input id="name" placeholder="è‹¥æŸ¥åˆ°æœƒè‡ªå‹•å¸¶ï¼›ä¹Ÿå¯æ‰‹å‹•/èªéŸ³è¼¸å…¥" />
    </label></div>

    <div class="row"><label>å“ç‰Œ
      <input id="brand" placeholder="è‹¥æŸ¥åˆ°æœƒè‡ªå‹•å¸¶" />
    </label></div>

    <div class="row"><label>æ•ˆæœŸ
      <input id="expiry" type="date" />
    </label></div>

    <div class="row"><label>é–‹å°æ—¥
      <input id="opened" type="date" /> <!-- é è¨­ç•™ç©º -->
    </label></div>

    <div class="row"><label>åˆ†é¡
      <select id="cat">
        <option>ç²¾è¯</option><option>åŒ–å¦æ°´</option><option>ä¹³æ¶²</option><option>é¢è†œ</option><option>é˜²æ›¬</option><option>å…¶ä»–</option>
      </select>
    </label></div>

    <div class="row"><label>å‚™è¨»
      <textarea id="note" rows="2" placeholder="å¯ç”¨èªéŸ³è¼¸å…¥"></textarea>
    </label></div>

    <div class="actions">
      <button id="submit">å¿«é€Ÿé€å‡º</button>
    </div>

    <div class="hint" id="status"></div>
  </div>

  <script type="module">
    import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/library@latest/+esm";
    const codeReader = new BrowserMultiFormatReader();

    const video   = document.getElementById("preview");
    const barcode = document.getElementById("barcode");
    const nameEl  = document.getElementById("name");
    const brandEl = document.getElementById("brand");
    const status  = document.getElementById("status");
    const imgBox  = document.getElementById("imgBox");
    const prodImg = document.getElementById("prodImg");

    // æ›æˆä½ çš„ Apps Script /exec URL
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbxtzZ7n6O7a_uGonhJEG6OwcPdLHWhK97zyJWTjXdDYKh5UqFl9-IvzmvWyHv0FIZQY/exec";

    let stream = null;
    let scanning = false;
    let handledThisScan = false;

    async function startScan(){
      if (scanning) return;
      handledThisScan = false;
      try{
        const devices = await navigator.mediaDevices.enumerateDevices();
        const backCam = devices.find(d => d.kind === "videoinput" && /back|rear|ç’°å¢ƒ/i.test(d.label));
        const constraints = { video: backCam ? { deviceId: backCam.deviceId } : { facingMode: "environment" } };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        scanning = true;
        status.textContent = "ç›¸æ©Ÿå·²å•Ÿç”¨ï¼Œè«‹å°æº–æ¢ç¢¼â€¦";

        codeReader.decodeFromVideoDevice(null, "preview", (result, err) => {
          if (result && !handledThisScan){
            handledThisScan = true;
            barcode.value = result.getText();
            if (navigator.vibrate) navigator.vibrate(60);
            status.textContent = "âœ… å·²æƒåˆ°æ¢ç¢¼ï¼š" + barcode.value + "ï¼ˆå·²è‡ªå‹•åœæ­¢æƒæä¸¦æŸ¥è³‡æ–™ï¼‰";
            stopScan();               // æƒåˆ°å³åœ
            lookup();                 // ç«‹åˆ»æŸ¥è³‡æ–™ï¼ˆä¸æœƒè¦†è“‹ä½ å·²è¼¸å…¥çš„æ–‡å­—ï¼‰
          }
        });
      }catch(e){
        status.textContent = "âš ï¸ ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿï¼š" + e;
      }
    }
    function stopScan(){
      try{ codeReader.reset(); }catch{}
      try{
        if (stream){
          stream.getTracks().forEach(t => t.stop());
          stream = null;
        }
      }catch{}
      scanning = false;
    }

    document.getElementById("btnStart").onclick = startScan;
    document.getElementById("btnStop").onclick  = stopScan;

    document.getElementById("btnNoBarcode").onclick = ()=>{
      barcode.value = "";
      status.textContent = "ğŸ‘‰ å°‡ä»¥å…§éƒ¨IDå»ºç«‹ï¼ˆç„¡æ¢ç¢¼ï¼‰";
      stopScan();
    };

    document.getElementById("btnLookup").onclick = lookup;

    // åªåœ¨æ¬„ä½ã€Œç›®å‰ç‚ºç©ºã€æ™‚æ‰å¯«å…¥ï¼Œé¿å…æ´—æ‰ä½ æ‰‹å‹•è¼¸å…¥
    function setIfEmpty(inputEl, val){
      if (!inputEl.value && val) inputEl.value = val;
    }

    // å…ˆè©¦ GAS lookupï¼›å¤±æ•—å°±æ‰“ OBF ç«¯é»
    async function lookup(){
      const bc = barcode.value.trim();
      if (!bc){ alert("è«‹å…ˆè¼¸å…¥æˆ–æƒææ¢ç¢¼"); return; }

      try{
        // 1) å˜—è©¦ GAS lookupï¼ˆå¦‚æœä½ å°šæœªåœ¨ app.gs å¯«é€™å€‹åˆ†æ”¯ï¼Œæœƒå›éŒ¯èª¤ â†’ é€²å…¥ catchï¼‰
        const url = `${GAS_ENDPOINT}?mode=lookup&barcode=${encodeURIComponent(bc)}`;
        const res = await fetch(url);
        if (res.ok){
          const json = await res.json();
          if (json && json.ok && json.data){
            applyLookup(json.data, /*from*/ 'GAS');
            return;
          }
        }
        throw new Error('GAS lookup not available');
      }catch{
        // 2) ç›´æ¥æŸ¥ OBFï¼ˆv2â†’v0ï¼‰
        try{
          const fields = 'product_name,product_name_zh,product_name_zh-TW,brands,ingredients_text,ingredients_text_zh,ingredients_text_zh-TW,image_url,code';
          const v2 = await fetch(`https://world.openbeautyfacts.org/api/v2/product/${encodeURIComponent(bc)}?fields=${encodeURIComponent(fields)}`);
          let data = v2.ok ? await v2.json() : null;
          if (!(data && (data.product))) {
            const v0 = await fetch(`https://world.openbeautyfacts.org/api/v0/product/${encodeURIComponent(bc)}.json?fields=${encodeURIComponent(fields)}`);
            data = v0.ok ? await v0.json() : null;
          }
          if (data && data.product){
            const p = data.product;
            const payload = {
              name: p['product_name_zh-TW'] || p['product_name_zh'] || p['product_name'] || '',
              brand: p['brands'] || '',
              image_url: p['image_url'] || '',
              source: 'obf'
            };
            applyLookup(payload, /*from*/ 'OBF');
          }else{
            status.textContent = "æŸ¥ç„¡è³‡æ–™ï¼Œå¯æ‰‹å‹•è¼¸å…¥ã€‚";
            imgBox.style.display = "none";
          }
        }catch(e2){
          status.textContent = "æŸ¥è©¢å¤±æ•—ï¼š" + e2;
        }
      }
    }

    function applyLookup(d, from){
      setIfEmpty(nameEl,  d.name);
      setIfEmpty(brandEl, d.brand);
      if (d.image_url){
        prodImg.src = d.image_url;
        imgBox.style.display = "block";
      }else{
        imgBox.style.display = "none";
      }
      status.textContent = `ğŸ“¦ å·²å¸¶å…¥ï¼ˆ${from}ï¼‰ï¼š${d.name || ''}`;
    }

    // é€å‡ºï¼ˆå­˜æª”ï¼‰â€” ä½¿ç”¨ POSTï¼Œä¸”ä¸è¨­å®š Content-Typeï¼ˆé¿å… CORS é æª¢ï¼‰
    document.getElementById("submit").onclick = async ()=>{
      const payload = {
        id: undefined,
        barcode: barcode.value.trim(),
        name: nameEl.value.trim(),
        brand: brandEl.value.trim(),
        expiry: document.getElementById("expiry").value,
        opened: document.getElementById("opened").value,   // å…è¨±ç©ºç™½
        category: document.getElementById("cat").value,
        note: document.getElementById("note").value.trim(),
        ts: new Date().toISOString(),
      };
      if (!payload.barcode && !payload.name){
        alert("æ²’æœ‰æ¢ç¢¼æ™‚è«‹è‡³å°‘å¡«ã€å“åã€");
        return;
      }
      try{
        const res = await fetch(GAS_ENDPOINT, { method:"POST", body: JSON.stringify(payload) });
        const json = await res.json();
        if (json.ok){
          alert("âœ… æ–°å¢æˆåŠŸï¼š" + (json.data.name || "(æœªå‘½å)"));
          // æ¸…ç©ºåªæ¸…ã€Œå¯èƒ½æƒ³é‡å¡«ã€çš„æ¬„ä½ï¼›ä¸è§¸åŠä½ å‰›æ‰‹å‹•éµå…¥çš„å…¶ä»–æ¬„ä½
          nameEl.value = "";
          brandEl.value = "";
          document.getElementById("expiry").value = "";
          document.getElementById("note").value = "";
          imgBox.style.display = "none";
        }else{
          alert("é€å‡ºå¤±æ•—ï¼š" + (json.error || "æœªçŸ¥éŒ¯èª¤"));
        }
      }catch(e){
        alert("é€£ç·šå¤±æ•—ï¼š" + e);
      }
    };
  </script>
</body>
</html>
