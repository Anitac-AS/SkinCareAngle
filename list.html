<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>ä¿é¤Šå“æ¸…å–®</title>
  
  <script src="https://apis.google.com/js/api.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #f4f6f8;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #007bff;
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.8em;
    }
    /* æ¸…å–®å®¹å™¨ */
    #listContainer {
      display: grid;
      gap: 15px;
    }
    /* ç”¢å“å¡ç‰‡ */
    .card {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      padding: 15px;
      display: flex;
      align-items: center;
      transition: transform 0.2s;
    }
    .card:active {
        transform: translateY(2px); /* æ‰‹æ©Ÿé»æ“Šæ•ˆæœ */
    }

    .photo-thumb {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      margin-right: 15px;
      flex-shrink: 0;
    }
    .details {
      flex-grow: 1;
      min-width: 0;
    }
    .brand-name {
      font-weight: bold;
      font-size: 1.2em;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .product-name {
      color: #6c757d;
      font-size: 1em;
      margin-bottom: 5px;
    }
    
    /* ç‹€æ…‹è­¦ç¤ºæ¨™ç±¤ */
    .status-tag {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.85em;
        font-weight: bold;
        margin-top: 5px;
        margin-right: 5px;
    }
    /* é¡è‰²å®šç¾© */
    .expired { /* å·²éæœŸ */
        background-color: #dc3545; /* ç´…è‰² */
        color: white;
    }
    .warning { /* å³å°‡éæœŸ (ä¾‹å¦‚ 90 å¤©å…§) */
        background-color: #ffc107; /* é»ƒè‰² */
        color: #333;
    }
    .opened { /* å·²é–‹å° */
        background-color: #17a2b8; /* æ·ºè—è‰² */
        color: white;
    }
    .default { /* æ­£å¸¸ç‹€æ…‹ */
        background-color: #28a745; /* ç¶ è‰² */
        color: white;
    }
    
    .loading-text {
        text-align: center;
        margin-top: 50px;
        color: #6c757d;
    }
    
  </style>
</head>
<body>
  <h1>ğŸ“‹ æˆ‘çš„ä¿é¤Šå“æ¸…å–®</h1>
  
  <div id="listContainer">
    <p class="loading-text">æ­£åœ¨å¾ Google Sheet è¼‰å…¥è³‡æ–™...</p>
  </div>
  
  <p style="text-align:center; margin-top:20px;">
    <a href="./index.html" style="color:#007bff; text-decoration: none; font-weight: bold; font-size: 1em;">
      â† è¿”å›å»ºæª”é é¢
    </a>
  </p>

  <script>
    // å®šç¾©æ—¥æœŸåˆ¤æ–·å¸¸æ•¸
    const WARNING_DAYS = 90; // æ•ˆæœŸåœ¨ 90 å¤©å…§è¦–ç‚ºè­¦å‘Š
    
    // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
    document.addEventListener('DOMContentLoaded', function() {
        // å¤–éƒ¨é é¢ç›´æ¥å‘¼å« Apps Script å¾Œç«¯çš„ getCosmeticData
        google.script.run
            .withSuccessHandler(renderList)
            .withFailureHandler(handleError)
            .getCosmeticData();
    });

    // æˆåŠŸè®€å–è³‡æ–™å¾Œæ¸²æŸ“æ¸…å–®
    function renderList(data) {
        const container = document.getElementById('listContainer');
        container.innerHTML = ''; // æ¸…ç©ºè¼‰å…¥ä¸­è¨Šæ¯

        if (data.length === 0) {
            container.innerHTML = '<p class="loading-text">æ¸…å–®ç›®å‰æ²’æœ‰ä»»ä½•ç”¢å“ã€‚</p>';
            return;
        }

        data.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            
            // åˆ¤æ–·ç‹€æ…‹
            const tagsHtml = getStatusTags(item);

            // å»ºç«‹å¡ç‰‡å…§å®¹
            card.innerHTML = `
                <img src="${item.ç…§ç‰‡é€£çµ}" class="photo-thumb" onerror="this.onerror=null;this.src='https://via.placeholder.com/80?text=No+Img';">
                <div class="details">
                    <div class="brand-name">${item.å“ç‰Œ || 'æœªçŸ¥å“ç‰Œ'}</div>
                    <div class="product-name">${item.å“å || 'æœªå‘½åç”¢å“'}</div>
                    ${tagsHtml}
                </div>
            `;
            container.appendChild(card);
        });
    }

    // ç‹€æ…‹åˆ¤æ–·é‚è¼¯ (è¦–è¦ºåŒ–æ ¸å¿ƒ)
    function getStatusTags(item) {
        const today = new Date();
        const tags = [];
        
        // --- 1. æ•ˆæœŸåˆ¤æ–· ---
        if (item.æ•ˆæœŸ) {
            const expiryDate = new Date(item.æ•ˆæœŸ);
            const diffTime = expiryDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                tags.push(`<span class="status-tag expired">ğŸš¨ å·²éæœŸ (${item.æ•ˆæœŸ})</span>`);
            } else if (diffDays <= WARNING_DAYS) {
                tags.push(`<span class="status-tag warning">âš ï¸ å³å°‡éæœŸ (${diffDays} å¤©)</span>`);
            } else {
                tags.push(`<span class="status-tag default">âœ” æ•ˆæœŸæ­£å¸¸</span>`);
            }
        } else {
            tags.push(`<span class="status-tag default">æ•ˆæœŸæœªå®š</span>`);
        }
        
        // --- 2. é–‹å°æ—¥åˆ¤æ–· (åªæ¨™è¨˜å·²é–‹å°ç‹€æ…‹) ---
        if (item.é–‹å°æ—¥) {
            tags.push(`<span class="status-tag opened">ğŸ“¦ å·²é–‹å° (${item.é–‹å°æ—¥})</span>`);
        } else {
            tags.push(`<span class="status-tag default">æœªé–‹å°</span>`);
        }
        
        return tags.join('');
    }

    // éŒ¯èª¤è™•ç†
    function handleError(error) {
        const container = document.getElementById('listContainer');
        container.innerHTML = `<p class="loading-text" style="color: #dc3545;">è³‡æ–™è¼‰å…¥éŒ¯èª¤ï¼š${error.message}</p><p class="loading-text">è«‹ç¢ºèªæ‚¨çš„ Apps Script Web App æ¬Šé™æ˜¯å¦è¨­å®šæ­£ç¢ºã€‚</p>`;
        console.error("GAS Error:", error);
    }
  </script>
</body>
</html>
