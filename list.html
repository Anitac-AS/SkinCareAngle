<!doctype html>
const devices = await navigator.mediaDevices.enumerateDevices();
const backCam = devices.find(d => d.kind === 'videoinput' && /back|rear|環境/i.test(d.label));
const constraints = { video: backCam ? { deviceId: backCam.deviceId } : { facingMode: 'environment' } };
const stream = await navigator.mediaDevices.getUserMedia(constraints);
video.srcObject = stream;


codeReader.decodeFromVideoDevice(null, 'preview', (result, err) => {
if (result){
barcode.value = result.getText();
if (navigator.vibrate) navigator.vibrate(60);
status.textContent = '已掃到條碼：' + barcode.value;
}
});
}catch(e){ status.textContent = '無法開啟相機：' + e; }


document.getElementById('btnNoBarcode').onclick = ()=>{
barcode.value = '';
status.textContent = '將以內部ID建立（無條碼）';
};


document.getElementById('submit').onclick = async ()=>{
const payload = {
id: undefined, // 可留空，後端自動產生
barcode: barcode.value.trim(),
name: document.getElementById('name').value.trim(),
expiry: document.getElementById('expiry').value,
opened: document.getElementById('opened').value,
category: document.getElementById('cat').value,
note: document.getElementById('note').value.trim(),
ts: new Date().toISOString()
};
if (!payload.barcode && !payload.name){
alert('沒有條碼時請至少填「品名」');
return;
}
try{
const res = await fetch(GAS_ENDPOINT, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
const json = await res.json();
if (json.ok){
alert('✅ 新增成功：' + (json.data.name || '(未命名)'));
document.getElementById('name').value='';
document.getElementById('expiry').value='';
document.getElementById('note').value='';
}else{
alert('送出失敗：' + (json.error||'未知錯誤'));
}
}catch(e){ alert('連線失敗：' + e); }
};
</script>
</body>
