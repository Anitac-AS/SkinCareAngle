<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>保養品拍照新增</title>
  <style>
    body{font-family:system-ui,-apple-system,Arial;background:#fafafa;padding:12px}
    .card{max-width:520px;margin:0 auto;background:#fff;border-radius:14px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .row{margin:10px 0}
    input,select,textarea,button{width:100%;padding:12px;border-radius:12px;border:1px solid #ddd;box-sizing:border-box}
    button{border:0;background:#1565c0;color:#fff;font-weight:600;cursor:pointer}
    button.secondary{background:#666}
    .preview{width:100%;border-radius:12px;background:#eee;object-fit:cover;max-height:260px}
    .hint{color:#666;font-size:13px;margin-top:6px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .progress{height:6px;background:#eee;border-radius:6px;overflow:hidden}
    .bar{height:100%;width:0;background:#1565c0}
  </style>
</head>
<body>
  <div class="card">
    <h3>保養品拍照新增</h3>

    <div class="row">
      <input id="file" type="file" accept="image/*" capture="environment" />
    </div>

    <div class="row">
      <img id="preview" class="preview" alt="預覽圖" style="display:none"/>
    </div>

    <div class="row">
      <div class="progress"><div class="bar" id="bar"></div></div>
      <div class="hint" id="status">請先拍照或選擇相片</div>
    </div>

    <div class="row"><label>品名
      <input id="name" placeholder="可手動輸入；亦可用『雲端 AI 辨識』帶入" />
    </label></div>

    <div class="row"><label>品牌
      <input id="brand" placeholder="可手動輸入；亦可用『雲端 AI 辨識』帶入" />
    </label></div>

    <div class="row"><label>效期
      <input id="expiry" type="date" />
    </label></div>

    <div class="row"><label>開封日
      <input id="opened" type="date" /> <!-- 預設空白 -->
    </label></div>

    <div class="row"><label>分類
      <select id="cat">
        <option>精華</option><option>化妝水</option><option>乳液</option><option>面膜</option><option>防曬</option><option>其他</option>
      </select>
    </label></div>

    <div class="row"><label>備註
      <textarea id="note" rows="2" placeholder="可補充容量、系列等"></textarea>
    </label></div>

    <div class="actions">
      <button id="btnAi" type="button" class="secondary">使用雲端 AI 辨識</button>
      <button id="submit">送出</button>
    </div>
  </div>

  <script>
    // 換成你的 Apps Script /exec URL
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbxtzZ7n6O7a_uGonhJEG6OwcPdLHWhK97zyJWTjXdDYKh5UqFl9-IvzmvWyHv0FIZQY/exec";

    const fileEl = document.getElementById('file');
    const imgEl  = document.getElementById('preview');
    const barEl  = document.getElementById('bar');
    const status = document.getElementById('status');
    const nameEl  = document.getElementById('name');
    const brandEl = document.getElementById('brand');

    let latestImageBlob = null;

    fileEl.addEventListener('change', async () => {
      const f = fileEl.files[0];
      if (!f) return;
      latestImageBlob = f;

      const url = URL.createObjectURL(f);
      imgEl.src = url;
      imgEl.style.display = 'block';
      barEl.style.width = '0%';
      status.textContent = '已載入圖片';
    });

    function setIfEmpty(input, value){
      if (!input.value && value) input.value = value;
    }

    // 雲端 AI 辨識（不寫入）
    document.getElementById('btnAi').onclick = async () => {
      const f = fileEl.files[0];
      if (!f) { alert('請先拍照或選擇相片'); return; }

      const fd = new FormData();
      fd.append('mode', 'analyzeOnly');
      fd.append('photo', f, f.name || 'photo.jpg');
      status.textContent = '上傳到雲端辨識中…';

      try{
        const res = await fetch(GAS_ENDPOINT, { method:'POST', body: fd });
        const json = await res.json();
        if (json.ok && json.ai){
          setIfEmpty(brandEl, json.ai.brand);
          setIfEmpty(nameEl,  json.ai.name);
          status.textContent = `AI 建議：${json.ai.brand || ''} / ${json.ai.name || ''}`;
        }else{
          status.textContent = 'AI 辨識失敗：' + (json.error || '無建議');
        }
      }catch(e){
        status.textContent = 'AI 連線失敗：' + e;
      }
    };

    // 送出（上傳＋寫入）
    document.getElementById('submit').onclick = async () => {
      const f = fileEl.files[0];
      if (!f) { alert('請先拍照或選擇相片'); return; }

      const fd = new FormData();
      fd.append('mode', 'addPhoto');
      fd.append('name',   nameEl.value.trim());
      fd.append('brand',  brandEl.value.trim());
      fd.append('expiry', document.getElementById('expiry').value);
      fd.append('opened', document.getElementById('opened').value);
      fd.append('category', document.getElementById('cat').value);
      fd.append('note',   document.getElementById('note').value.trim());
      fd.append('photo',  f, f.name || 'photo.jpg');

      try{
        const res = await fetch(GAS_ENDPOINT, { method:'POST', body: fd });
        const json = await res.json();
        if (json.ok){
          alert('✅ 已新增：' + (json.data.name || '(未命名)'));
          // 清空可重填欄位
          nameEl.value='';
          brandEl.value='';
          document.getElementById('expiry').value='';
          document.getElementById('note').value='';
          status.textContent = '已寫入';
        }else{
          alert('送出失敗：' + (json.error || '未知錯誤'));
        }
      }catch(e){
        alert('連線失敗：' + e);
      }
    };
  </script>
</body>
</html>
