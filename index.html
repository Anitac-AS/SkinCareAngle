<!DOCTYPE html>
<html>
<head>
Â  <base target="_top">
Â  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
Â  <title>ä¿é¤Šå“å¿«é€Ÿå»ºæª”å·¥å…·</title>
Â  
Â  Â  <script type="text/javascript" 
Â          src="https://script.google.com/macros/s/AKfycbyFfj4pKcDgA1AMEax5U3dt4qLZnxY9UUnmE7zyzjtAY65GnJWzWcthh2sfD4RizewV/externalload"></script>
Â  <script src="https://apis.google.com/js/api.js"></script> 
Â  
Â  <style>
/* ... (æ‰€æœ‰ CSS æ¨£å¼ä¿ç•™ä¸è®Š) ... */
</style>
</head>
<body>
Â  <div class="container">
Â  Â  <h1 class="header">ğŸ“¸ å¿«é€Ÿå»ºæª”</h1>
Â  Â  
Â  Â  <form id="cosmeticForm"> 
Â  Â  Â  
Â  Â  Â  <section class="photo-section">
Â  Â  Â  Â  <label for="photoFile" class="file-label">é»æ“Šæ‹ç…§æˆ–ä¸Šå‚³åœ–ç‰‡</label>
Â  Â  Â  Â  <input type="file" id="photoFile" name="photoFile" accept="image/*" capture="environment" required>
Â  Â  Â  Â  <button type="button" id="aiDetectBtn" class="action-btn detect-btn">ğŸ¤– é›²ç«¯ AI è¾¨è­˜</button>
Â  Â  Â  Â  <div id="aiStatus" class="status-msg"></div>
Â  Â  Â  </section>

Â  Â  Â  <section class="info-section">
Â  Â  Â  Â  <h2>ç”¢å“è³‡è¨Š</h2>
Â  Â  Â  Â  
Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  <label for="brand">å“ç‰Œ *</label>
Â  Â  Â  Â  Â  <input type="text" id="brand" name="brand" placeholder="ä¾‹å¦‚ï¼šSK-II" required>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  
Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  <label for="name">å“å *</label>
Â  Â  Â  Â  Â  <input type="text" id="name" name="name" placeholder="ä¾‹å¦‚ï¼šé’æ˜¥éœ²" required>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  <label for="category">åˆ†é¡</label>
Â  Â  Â  Â  Â  <select id="category" name="category">
Â  Â  Â  Â  Â  Â  <option value="">è«‹é¸æ“‡</option>
Â  Â  Â  Â  Â  Â  <option value="ç²¾è¯æ¶²">ç²¾è¯æ¶²</option>
Â  Â  Â  Â  Â  Â  <option value="åŒ–å¦æ°´">åŒ–å¦æ°´</option>
Â  Â  Â  Â  Â  Â  <option value="ä¹³æ¶²/é¢éœœ">ä¹³æ¶²/é¢éœœ</option>
Â  Â  Â  Â  Â  Â  <option value="çœ¼éœœ">çœ¼éœœ</option>
Â  Â  Â  Â  Â  Â  <option value="è©¦ç”¨å“">è©¦ç”¨å“</option>
Â  Â  Â  Â  Â  Â  <option value="å…¶ä»–">å…¶ä»–</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  
Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  <label for="expiryDate">æ•ˆæœŸ</label>
Â  Â  Â  Â  Â  <input type="date" id="expiryDate" name="expiryDate">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  
Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  <label for="openDate">é–‹å°æ—¥</label> 
Â  Â  Â  Â  Â  <input type="date" id="openDate" name="openDate">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  
Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  <label for="notes">å‚™è¨»</label>
Â  Â  Â  Â  Â  <textarea id="notes" name="notes" rows="3" placeholder="ä¾‹å¦‚ï¼šé©ç”¨å†¬å­£ä¹¾è‚Œï¼Œå·²é€å‡ºå…¬é—œå“"></textarea>
Â  Â  Â  Â  </div>
Â  Â  Â  </section>
Â  Â  Â  
Â  Â  Â  <button type="submit" id="submitBtn" class="action-btn submit-btn">ğŸš€ å„²å­˜ä¸¦é€å‡º</button>
Â  Â  Â  <div id="loadingStatus" class="status-msg"></div>
Â  Â  </form>
Â  </div>
Â  
Â  <div style="text-align: center; margin-top: 20px;">
Â  Â  <a href="./list.html" style="color:#007bff; text-decoration: none; font-weight: bold; font-size: 1.1em;">
Â  Â  Â  Â  æŸ¥çœ‹æ‰€æœ‰ç”¢å“æ¸…å–®
Â  Â  </a>
Â  </div>

Â  <script>

// VVVV é—œéµä¿®æ­£ (A)ï¼šå°‡æ‰€æœ‰è¼”åŠ©å‡½å¼å®šç¾©ç§»åˆ°é ‚å±¤ VVVV
// è®“æ‰€æœ‰äº‹ä»¶ç›£è½å™¨éƒ½èƒ½æ‰¾åˆ°å®ƒå€‘

// æˆåŠŸè™•ç†å¾Œçš„è™•ç†å™¨ (ä¸Šå‚³)
function onSuccess(response) {
    const loadingStatus = document.getElementById('loadingStatus');
    document.getElementById('submitBtn').disabled = false;
    document.getElementById('cosmeticForm').reset();
    document.querySelector('.file-label').textContent = 'é»æ“Šæ‹ç…§æˆ–ä¸Šå‚³åœ–ç‰‡';
    document.getElementById('aiStatus').innerHTML = '';
    loadingStatus.innerHTML = `âœ… ${response.message || 'å»ºæª”æˆåŠŸï¼'}`;
    loadingStatus.style.color = '#28a745'; 
    setTimeout(() => loadingStatus.innerHTML = '', 3000);
}

// å¤±æ•—è™•ç†å¾Œçš„è™•ç†å™¨ (ä¸Šå‚³)
function onFailure(error) {
    const loadingStatus = document.getElementById('loadingStatus');
    document.getElementById('submitBtn').disabled = false;
    loadingStatus.innerHTML = `âŒ éŒ¯èª¤ï¼š${error.message || 'å»ºæª”å¤±æ•—ã€‚'}`;
    loadingStatus.style.color = '#dc3545';
    console.error("éŒ¯èª¤è©³æƒ…ï¼š", error);
}

// AI è¾¨è­˜æˆåŠŸè™•ç†å™¨
function onAiSuccess(result) {
    const aiStatus = document.getElementById('aiStatus');
    if (result.error) { aiStatus.innerHTML = `âŒ è¾¨è­˜å¤±æ•—: ${result.error}`; aiStatus.style.color = '#dc3545'; return; }
    if (result.brand) { document.getElementById('brand').value = result.brand; }
    if (result.name) { document.getElementById('name').value = result.name; }
    aiStatus.innerHTML = `âœ… AI è¾¨è­˜å®Œæˆï¼å“ç‰Œ: ${result.brand || 'ç„¡'}ï¼Œå“å: ${result.name || 'ç„¡'}`;
    aiStatus.style.color = '#28a745';
    setTimeout(() => aiStatus.innerHTML = '', 5000);
}

// AI è¾¨è­˜å¤±æ•—è™•ç†å™¨
function onAiFailure(error) {
    const aiStatus = document.getElementById('aiStatus');
    aiStatus.innerHTML = `âŒ ç³»çµ±éŒ¯èª¤ï¼š${error.message || 'AI è¾¨è­˜è™•ç†ç•°å¸¸ã€‚'}`;
    aiStatus.style.color = '#dc3545';
}

// VVVV æ ¸å¿ƒ API URL VVVV
const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyFfj4pKcDgA1AMEax5U3dt4qLZnxY9UUnmE7zyzjtAY65GnJWzWcthh2sfD4RizewV/exec'; 
// ^^^^ æ ¸å¿ƒ API URL ^^^^


document.addEventListener('DOMContentLoaded', function() {

    // --------------------------------------------------------------------------------
    // --- æ ¸å¿ƒæäº¤é‚è¼¯ï¼šä½¿ç”¨ FETCH API (ä¸Šå‚³) ---
    // --------------------------------------------------------------------------------
    document.getElementById('cosmeticForm').addEventListener('submit', async function(e) {
        e.preventDefault(); 

        const form = e.target;
        const submitBtn = document.getElementById('submitBtn');
        const loadingStatus = document.getElementById('loadingStatus');

        submitBtn.disabled = true;
        loadingStatus.innerHTML = 'æ­£åœ¨è™•ç†ä¸¦ä¸Šå‚³ä¸­... è«‹ç¨å€™';
        loadingStatus.style.color = '#007bff';

        const formData = new FormData(this); 
        formData.append('action', 'upload'); // å‘ŠçŸ¥å¾Œç«¯é€™æ˜¯ä¸Šå‚³å‹•ä½œ

        try {
            const response = await fetch(GAS_API_URL, {
                method: 'POST',
                body: formData 
            });
            
            const result = await response.json(); 
            
            if (result.status === 'success') {
                onSuccess(result);
            } else {
                onFailure(new Error(result.message));
            }

        } catch (error) {
            // æ•æ‰åˆ° CORS éŒ¯èª¤æ™‚ï¼Œé¡¯ç¤ºæ›´æ˜ç¢ºçš„è¨Šæ¯
            if (error.message.includes('Failed to fetch')) {
                 onFailure(new Error(`é€£ç·šå¤±æ•—ã€‚è«‹ç¢ºèª Apps Script å·²éƒ¨ç½²ï¼Œä¸”æ‚¨çš„ç€è¦½å™¨å…è¨±è·¨åŸŸè«‹æ±‚ï¼ˆCORSï¼‰ã€‚`));
            } else {
                 onFailure(new Error(`ç¶²è·¯é€£ç·šéŒ¯èª¤æˆ– API ç•°å¸¸ï¼š${error.message}`));
            }
        }
    });


    // --------------------------------------------------------------------------------
    // --- AI è¾¨è­˜é‚è¼¯ï¼šä»ä¾è³´ google.script.run ---
    // --------------------------------------------------------------------------------
    document.getElementById('aiDetectBtn').addEventListener('click', function() {
        const aiStatus = document.getElementById('aiStatus');
        const photoFile = document.getElementById('photoFile');

        if (photoFile.files.length === 0) {
            aiStatus.innerHTML = 'è«‹å…ˆé¸å–ä¸€å¼µç…§ç‰‡ï¼';
            aiStatus.style.color = '#ffc107';
            return;
        }
        
        const file = photoFile.files[0];
        const reader = new FileReader();

        aiStatus.innerHTML = 'æ­£åœ¨é€²è¡Œ AI è¾¨è­˜...';
        aiStatus.style.color = '#007bff';
        
        reader.onload = function(e) {
            const base64Data = e.target.result.split(',')[1];
            
            // å‘¼å« GAS ä¼ºæœå™¨ç«¯å‡½å¼ (AI è¾¨è­˜)
            // âš ï¸ é€™è£¡ä»éœ€ google.script.runï¼Œæ‰€ä»¥ä¾è³´æ–¼æ‚¨çš„ç€è¦½å™¨èƒ½æˆåŠŸè¼‰å…¥æ©‹æ¥ç¢¼
            google.script.run
                .withSuccessHandler(onAiSuccess)
                .withFailureHandler(onAiFailure)
                .callAIDetection(base64Data);
        };
        
        reader.onerror = function() {
            onAiFailure(new Error("ç„¡æ³•è®€å–åœ–ç‰‡æª”æ¡ˆã€‚"));
        };

        reader.readAsDataURL(file); 
    });


    // --- åœ–ç‰‡é è¦½åŠŸèƒ½ ---
    document.getElementById('photoFile').addEventListener('change', function() {
        const fileLabel = document.querySelector('.file-label');
        const file = this.files[0];
        if (file) {
            fileLabel.textContent = `å·²é¸å–ï¼š${file.name}`;
        } else {
            fileLabel.textContent = 'é»æ“Šæ‹ç…§æˆ–ä¸Šå‚³åœ–ç‰‡';
        }
    });

});
Â  </script>
</body>
</html>
