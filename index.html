<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>保養品快速建檔工具</title>
  
    <script type="text/javascript" 
          src="https://script.google.com/macros/s/AKfycbyFfj4pKcDgA1AMEax5U3dt4qLZnxY9UUnmE7zyzjtAY65GnJWzWcthh2sfD4RizewV/externalload"></script>
    <script src="https://apis.google.com/js/api.js"></script> 

  <style>
/* ... (保留所有 CSS 樣式) ... */
    body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
  background-color: #f4f6f8; 
  margin: 0;
  padding: 0;
}

.container {
  max-width: 600px;
  margin: 0 auto;
  padding: 20px;
}

.header {
  text-align: center;
  color: #007bff; 
  margin-bottom: 30px;
  font-size: 1.8em;
}

/* 輸入群組樣式 */
.input-group {
  margin-bottom: 15px;
}

label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
  color: #333;
  font-size: 1.1em;
}

input[type="text"], 
input[type="date"], 
select, 
textarea {
  width: 100%;
  padding: 12px;
  margin-top: 5px;
  box-sizing: border-box;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 1.1em; 
}

textarea {
  resize: vertical;
}

/* 按鈕樣式：適合單手點擊的大尺寸 */
.action-btn {
  width: 100%;
  padding: 15px;
  border: none;
  border-radius: 10px;
  font-size: 1.2em;
  font-weight: bold;
  cursor: pointer;
  margin-top: 15px;
  transition: background-color 0.3s;
}

.detect-btn {
  background-color: #ffc107; 
  color: #333;
}

.submit-btn {
  background-color: #28a745; 
  color: white;
  margin-bottom: 50px; 
}

.detect-btn:hover { background-color: #e0a800; }
.submit-btn:hover { background-color: #1e7e34; }

/* 隱藏原生檔案上傳按鈕，使用客製化的 Label */
#photoFile {
  display: none; 
}

.file-label {
  display: block;
  text-align: center;
  padding: 20px;
  background-color: #e9ecef; 
  border: 2px dashed #adb5bd;
  border-radius: 10px;
  color: #6c757d;
  font-weight: bold;
  cursor: pointer;
  font-size: 1.1em;
  margin-bottom: 10px;
}

.status-msg {
  margin-top: 10px;
  padding: 10px;
  text-align: center;
  font-weight: bold;
}
  </style>
</head>
<body>
  <div class="container">
    <h1 class="header">📸 快速建檔</h1>
    
    <form id="cosmeticForm"> 
      
      <section class="photo-section">
        <label for="photoFile" class="file-label">點擊拍照或上傳圖片</label>
        <input type="file" id="photoFile" name="photoFile" accept="image/*" capture="environment" required>
        <button type="button" id="aiDetectBtn" class="action-btn detect-btn">🤖 雲端 AI 辨識</button>
        <div id="aiStatus" class="status-msg"></div>
      </section>

      <section class="info-section">
        <h2>產品資訊</h2>
        
        <div class="input-group">
          <label for="brand">品牌 *</label>
          <input type="text" id="brand" name="brand" placeholder="例如：SK-II" required>
        </div>
        
        <div class="input-group">
          <label for="name">品名 *</label>
          <input type="text" id="name" name="name" placeholder="例如：青春露" required>
        </div>

        <div class="input-group">
          <label for="category">分類</label>
          <select id="category" name="category">
            <option value="">請選擇</option>
            <option value="精華液">精華液</option>
            <option value="化妝水">化妝水</option>
            <option value="乳液/面霜">乳液/面霜</option>
            <option value="眼霜">眼霜</option>
            <option value="試用品">試用品</option>
            <option value="其他">其他</option>
          </select>
        </div>
        
        <div class="input-group">
          <label for="expiryDate">效期</label>
          <input type="date" id="expiryDate" name="expiryDate">
        </div>
        
        <div class="input-group">
          <label for="openDate">開封日</label> 
          <input type="date" id="openDate" name="openDate">
        </div>
        
        <div class="input-group">
          <label for="notes">備註</label>
          <textarea id="notes" name="notes" rows="3" placeholder="例如：適用冬季乾肌，已送出公關品"></textarea>
        </div>
      </section>
      
      <button type="submit" id="submitBtn" class="action-btn submit-btn">🚀 儲存並送出</button>
      <div id="loadingStatus" class="status-msg"></div>
    </form>
  </div>
  
  <div style="text-align: center; margin-top: 20px;">
    <a href="./list.html" style="color:#007bff; text-decoration: none; font-weight: bold; font-size: 1.1em;">
        查看所有產品清單
    </a>
  </div>

<script>
// VVVV 關鍵修正：這是 Content Service API 的 URL (已填入您的 URL) VVVV
const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyFfj4pKcDgA1AMEax5U3dt4qLZnxY9UUnmE7zyzjtAY65GnJWzWcthh2sfD4RizewV/exec'; 
// ^^^^ 關鍵修正 ^^^^

document.addEventListener('DOMContentLoaded', function() {

// --------------------------------------------------------------------------------
// --- 核心提交邏輯：使用原生 FETCH API (上傳) ---
// --------------------------------------------------------------------------------
    document.getElementById('cosmeticForm').addEventListener('submit', async function(e) {
        e.preventDefault(); 

        const form = e.target;
        const submitBtn = document.getElementById('submitBtn');
        const loadingStatus = document.getElementById('loadingStatus');

        submitBtn.disabled = true;
        loadingStatus.innerHTML = '正在處理並上傳中... 請稍候';
        loadingStatus.style.color = '#007bff';

        const formData = new FormData(this); 
        formData.append('action', 'upload'); // 告知後端這是上傳動作

        try {
            const response = await fetch(GAS_API_URL, {
                method: 'POST',
                body: formData 
            });
            
            const result = await response.json(); 
            
            if (result.status === 'success') {
                onSuccess(result);
            } else {
                onFailure(new Error(result.message));
            }

        } catch (error) {
            onFailure(new Error(`網路連線錯誤或 API 異常：${error.message}`));
        }
    });


// --------------------------------------------------------------------------------
// --- AI 辨識邏輯：使用 FETCH API (辨識) ---
// --------------------------------------------------------------------------------
    document.getElementById('aiDetectBtn').addEventListener('click', async function() {
        const aiStatus = document.getElementById('aiStatus');
        const photoFile = document.getElementById('photoFile');

        // ... (省略檔案檢查邏輯) ...

        const file = photoFile.files[0];
        const reader = new FileReader();

        aiStatus.innerHTML = '正在進行 AI 辨識...';
        aiStatus.style.color = '#007bff';
        
        reader.onload = async function(e) {
            const base64Data = e.target.result.split(',')[1];
            
            const aiFormData = new FormData();
            aiFormData.append('action', 'detect');
            aiFormData.append('base64Image', base64Data); // 傳遞 Base64 字串

            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: aiFormData
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    onAiSuccess(result.result); // result.result 包含品牌和品名
                } else {
                    onAiFailure(new Error(result.message));
                }

            } catch (error) {
                onAiFailure(new Error(`API 辨識連線錯誤：${error.message}`));
            }
        };
        
        reader.readAsDataURL(file); 
    });


// --------------------------------------------------------------------------------
// --- 輔助函式定義 ---
// --------------------------------------------------------------------------------

    // ... (保留所有 onSuccess, onFailure, onAiSuccess, onAiFailure 函式)
    // ... (保留圖片預覽功能)

});
</script>
</body>
</html>
